# Multi-Wallet & Vault Identity Architecture

## 1. Overview
The Multi-Wallet Identity system decouples a user's **Physical Identity** (the Principal used to log in) from their **Digital Assets** (tokens, staked power, and profile data). This allows a single user to link multiple wallets (Principals) to one account, enabling secure recovery, tiered authority, and "vault-like" security for high-value holders (Founders).

---

## 2. System Components

### A. The Principal (The Key)
A cryptographic identity generated by Internet Identity, NFID, or Hardware Wallets. In this system, a Principal is just a **key** that opens a door; it does not "own" the assets directly on the Ledger.

### B. The User Shard (The Apartment)
One of many `user_profile` canisters. It stores the actual user data, the list of authorized Principals, and acts as the **Smart Contract Wallet** manager.

### C. The Vault (The Mailbox)
A specific **Subaccount** on the GHC Ledger (ICRC-1). 
* **Owner**: The User Shard Canister ID.
* **Subaccount**: A 32-byte blob derived from the `AccountId`.

---

## 3. High-Level Architecture Diagram

```text
      [ USER DEVICES ]            [ ROUTING LAYER ]           [ DATA & ASSET LAYER ]
      
      +------------+                                         +-----------------------+
      | Laptop Key | --+                                     |    USER SHARD #05     |
      | (NFID)     |   |                                     | (The Home Canister)   |
      +------------+   |        +------------------+         |                       |
                       +------> |  HASH RING MAP   | ------> | [ Vlad's Profile ]    |
      +------------+   |        | (Staking Hub)    |         | - Authorized Keys     |
      | Phone Key  | --+        +------------------+         | - Staked Balance      |
      | (II)       |                                         | - Account ID: 101     |
      +------------+                                         +-----------+-----------+
                                                                         |
                                                                         | (Proxy Call)
      [ GHC LEDGER ]                                                     |
      +------------------------------------------------------------------v-----------+
      |                                                                              |
      |  CANISTER ID: USER_SHARD_#05                                                 |
      |  +---------------------------+  +---------------------------+                |
      |  | SUBACCOUNT: 101 (Vlad)    |  | SUBACCOUNT: 102 (Sarah)   |                |
      |  | Balance: 50,000 GHC       |  | Balance: 1,500 GHC        |                |
      |  +---------------------------+  +---------------------------+                |
      |                                                                              |
      +------------------------------------------------------------------------------+
```

---

## 4. The Scaling Model: Distributed Hash Ring

To prevent a central "Router" canister from becoming a bottleneck, we use **Deterministic Routing** based on a Hash Ring.

### The Algorithm:
1. **Hashing**: `Shard_Index = Hash(Caller_Principal) % Total_Shards`
2. **The Lookup**:
   * The Frontend hashes its login key and talks to the resulting Shard ID.
   * If the Key is a "Secondary Key," that shard contains a **Pointer** to the user's **Home Shard**.
   * If the Key is a "Primary Key," the user's full data is right there.

### ASCII Routing Flow:
```text
[ LOGIN WITH PHONE ] 
        |
        v
[ Hash(Phone) % 100 ] = Shard #12
        |
        v
[ Call Shard #12 ] ------> [ Contains Tiny Pointer ]
                            "This key belongs to User #101"
                            "Go to Home Shard #05"
        |
        v
[ Frontend Call ] -------> [ User Shard #05 ]
                            "Authenticated. Load Profile."
```

---

## 5. Security & Recovery Flow

### A. Higher Authority (Founder Recovery)
Founders can designate one Principal as the **Root Principal** (e.g., a cold-storage Ledger Nano). Root principals have the exclusive right to:
1. Revoke any other linked key.
2. Change the payout destination of the Vault.

### B. Revocation Scenario (Device Stolen)
```text
1. [ HACKER ] Steals Phone (Principal B).
2. [ FOUNDER ] Notices loss. Logs in via Laptop (Principal A).
3. [ SHARD CANISTER ] Receives request: "Revoke Principal B".
4. [ SHARD CANISTER ] Deletes Principal B from 'authorized_keys' list.
5. [ RESULT ] Hacker attempts to move funds. Shard Canister rejects 
              the request because Principal B is no longer authorized.
              TOKENS REMAIN SAFE IN THE VAULT SUBACCOUNT.
```

---

## 6. Data Structures (Rust)

### User Profile Shard
```rust
pub struct UserProfile {
    pub account_id: u64,               // Immutable unique ID
    pub root_key: Principal,           // Emergency/Master key
    pub authorized_keys: Vec<Principal>, // Daily use keys (Mobile/Browser)
    pub vault_subaccount: [u8; 32],    // Dedicated GHC Ledger subaccount
    pub personal_info: UserData,       // Name, Email, Stats
}

pub enum ShardEntry {
    Full(UserProfile),                 // User lives here
    Pointer { home_shard: Principal }, // User lives elsewhere
}
```

---

## 7. Key Features Summary

| Feature | Mechanism | Benefit |
| :--- | :--- | :--- |
| **Recovery** | Multiple Linked Principals | Lose a device, not the account. |
| **Vaulting** | Canister Subaccounts | Tokens are guarded by logic, not just a raw key. |
| **Scale** | Consistent Hashing | No central bottleneck; scales to 1,000+ shards. |
| **Founder Safety** | Root Principal | High-value users keep "Master keys" offline. |
| **Privacy** | Subaccount Derivation | Harder to track individual users on the public ledger. |
